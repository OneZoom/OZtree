

<!DOCTYPE html>
<html>
<head>
  <meta NAME="description" CONTENT="OneZoom Tree of Life Explorer" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="shortcut icon" href="favicon.ico" type="image/ico" />

  <title>OneZoom Tree of Life Explorer, text page for Minimal OneZoom page</title>
  
<script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_datetime_format = "%Y-%m-%d %H:%M:%S";
var w2p_ajax_date_format = "%Y-%m-%d";
var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
var ajax_error_500 = "An error occured, please <a href=\"/treeviewer/minlife_tour\">reload</a> the page";
var w2p_ajax_disable_with_message = "Working...";

    //--></script>

<meta name="keywords" content="onezoom, one, zoom, fractal, tree, tree of life, phylogeny, explorer, life, species, biology, earth, deep zoom, big data, encyclopedia, evolution, ecology, sponsor" />
<meta name="description" content="Tree of life explorer" />
<meta name="generator" content="Web2py Web Framework" />
<meta name="author" content="OneZoom Team" />
<script src="js/jquery.min.js" type="text/javascript"></script><link href="css/calendar.css" rel="stylesheet" type="text/css" /><script src="js/calendar.js" type="text/javascript"></script><script src="js/web2py.js" type="text/javascript"></script>

  <link rel="stylesheet" href="uikit-3/css/uikit.min.css" />
  <script src="uikit-3/js/uikit.min.js"></script>
  <script src="uikit-3/js/uikit-icons.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/tree.css" />
  <link rel="stylesheet" type="text/css" href="css/OZ_shared.css" />
  
  <!-- do not change the next line in any way. The exact format is used for partial installs -->
  <div id="OZ_js_modules">
  <script src="OZTreeModule/dist/OZentry.js"></script><script src="OZTreeModule/dist/search_ui.js"></script>
  </div>

  <!-- treeviewer constants -->
  
  <!-- Load local versions of the files first. If the return value from the API/version call does not match, variables in here will simply be replaced -->
  <script type="text/javascript" src="FinalOutputs/data/completetree_25589581.js"></script>
  <script type="text/javascript" src="FinalOutputs/data/cut_position_map_25589581.js"></script>
  <script type="text/javascript" src="FinalOutputs/data/dates_25589581.js"></script>

  <script type="text/javascript">
    /* we load the data files dynamically because they:
     *  (a) are large and
     *  (b) depend on a version number collected via an ajax call 
     */
    var version_error = function(data) {
      document.write('<h1 id="version-error">Sorry, there has been a OneZoom version error</h1><p>Please contact mail@onezoom.org quoting the following error:</p>' + 
        '<blockquote>' + data + '<blockquote>');
    };
    var dynamic_scripts_to_load = [
        'http://beta.onezoom.org/OZtree/static/FinalOutputs/data/completetree_...VERSION....js',
        'http://beta.onezoom.org/OZtree/static/FinalOutputs/data/cut_position_map_...VERSION....js',
        'http://beta.onezoom.org/OZtree/static/FinalOutputs/data/dates_...VERSION....js'
    ];
    $.each(dynamic_scripts_to_load, function() {$.holdReady(true);}); //hold the ready state from firing until all dynamic_scripts are loaded
    $.ajax({
      type:"GET", 
      url: "http://beta.onezoom.org/API/version.json", 
      success: function(data) {
        if (parseInt(data.version)) {
          
          if (data.version == "25589581") {
            
            $.each(dynamic_scripts_to_load, function() {$.holdReady(false);}); //once added to the head, these should force page to wait until all loaded before ready
          } else {
            alert("The local files in this restricted version of the OneZoom viewer are out of date. Please update your version. " + 
                "Meanwhile, all data files are being supplanted by remote versions, which is slower")
          
            $.each(dynamic_scripts_to_load, 
              function(index, src_name) {
                $.ajax({
                  url: src_name.replace("...VERSION...", data.version),
                  dataType: "script",
                  cache: true, //these version scripts never change, so we can always cache them
                  success: function() {
                    $.holdReady(false);
                    
                  },
                  error: function() {version_error("Could not get " + this.url);}
                });
              });
          }
        } else {
            version_error(data.error);
        }
      },
      error: function() {version_error("Could not get " + this.url);}
    });
  </script>

    <script type="text/javascript">
var server_urls = {
  /* These fill out the equivalently named variables in OneZoom global_config.
     They need to be defined in this file to avoid hard-coding them into the OneZoom js code 
     They are coded with the full URL so that they can be used remotely (e.g. in a partial install) */
  data_path_pics: function(src, src_id, preferred_px, square) {return "http://images.onezoom.org/" + src + "/" + src_id.toString().slice(-3) + "/" + src_id + ".jpg";},
  node_details_api: "http://beta.onezoom.org/API/node_details.json",
  search_api: "http://beta.onezoom.org/API/search_node.json",
  search_sponsor_api: "http://beta.onezoom.org/API/search_for_sponsor.json",
  search_init_api: "http://beta.onezoom.org/API/search_init.json",
  ott2id_arry_api: "http://beta.onezoom.org/API/get_ids_by_ott_array.json",
  otts2vns_api: "http://beta.onezoom.org/API/otts2vns.json",
  image_details_api: "http://beta.onezoom.org/API/image_details.json",
  update_visit_count_api: "http://beta.onezoom.org/API/update_visit_count.json",
  tourstop_page: "http://beta.onezoom.org/tourstop.load",

  
  OZ_leaf_json_url_func: function(ott, lang) {return("http://beta.onezoom.org/tree/leaf_linkouts.json/...OTT...?embed=1&lang=...LANG...".replace('...OTT...', (ott || '').toString() || "").replace('...LANG...', lang || ''))},
  OZ_node_json_url_func: function(id, lang) {return("http://beta.onezoom.org/tree/node_linkouts.json/...ID...?embed=1&lang=...LANG...".replace('...ID...', id.toString() || "").replace('...LANG...', lang || ''))},
};
  </script>

  <script>var OZstrings={"Sponsored by": "Sponsored by", "Sponsored for a person of your choice": "Sponsored for a person of your choice", "Popular places": "Popular places", "spp": "species", "NoEmailFromMD": "Sorry, you can\u2019t send an email directly from this display. Please use your own email program, and contact us at: ", "Sponsored by you": "Sponsored by you", "tya": "{tya} thousand years ago", "No known name": "No known name", "Current location": "Current location", "Conservation": "Conservation", "SponsorHits": "Sponsorships", "IUCN Red List status:": "IUCN Red List status:", "sponsor_text": {"node": {"named": "Sponsor one of the {group_name}", "unnamed": "Sponsor one of these"}, "leaf": [["YOUR NAME COULD GO HERE", ". DONATIONS HELP IMPROVE THIS PUBLIC RESOURCE"], ["YOUR FRIEND'S NAME COULD GO HERE", ". DONATIONS HELP US CONTINUE OUR WORK"], ["YOU COULD SPONSOR THIS LEAF FOR A FRIEND", ". IT MAKES A GREAT GIFT"]]}, "node_labels": {"with_pic": {"undated": {"named": "The most recent\ncommon ancestor to today\u2019s\n\n\n", "unnamed": "\nThe most recent\ncommon ancestor to species including\n\n"}, "dated": {"named": "{date_with_units},\nduring {geo_time}, lived\nthe most recent common ancestor to today\u2019s\n\n", "unnamed": "{date_with_units},\nduring {geo_time},\nlived the most recent common\nancestor to species including\n"}}, "text_only": {"undated": {"named": "\nThe most recent\ncommon ancestor to today\u2019s", "unnamed": "\n\nThe most recent common ancestor to"}, "dated": {"named": "{date_with_units},\nduring {geo_time}, lived\nthe most recent common ancestor to today\u2019s", "unnamed": "{date_with_units},\nduring {geo_time}, lived\nthe most recent common ancestor to"}}}, "No common name": "No common name", "loading...": "loading...", "Also called:": "Also called:", "Select 1st search box species": "Please select a species in the first search box", "EOLimage_problem": "The Encyclopedia of Life may have other\nimages, but EoL is currently unavailable", "leaf_sponsored": "This leaf has been sponsored", "Select 2nd search box species": "Please select a species in the second search box", "Click to search among sponsors of the tree": "Click to search among sponsors of the tree", "sp": "species", "Sponsored for": "Sponsored for", "geological": {"eons": [{"Ma": 541, "name": "Phanerozoic", "long": "the Phanerozoic eon"}, {"Ma": 2500, "name": "Proterozoic", "long": "the Proterozoic eon"}, {"Ma": 4000, "name": "Archean", "long": "the Archean eon"}, {"Ma": 5000, "name": "Hadean", "long": "the Hadean eon"}], "periods": [{"Ma": 2.58, "name": "Quaternary", "long": "the Quaternary period"}, {"Ma": 23.03, "name": "Neogene", "long": "the Neogene period"}, {"Ma": 66.0, "name": "Paleogene", "long": "the Paleogene period"}, {"Ma": 145.0, "name": "Cretaceous", "long": "the Cretaceous period"}, {"Ma": 201.3, "name": "Jurassic", "long": "the Jurassic period"}, {"Ma": 252.17, "name": "Triassic", "long": "the Triassic period"}, {"Ma": 298.9, "name": "Permian", "long": "the Permian period"}, {"Ma": 358.9, "name": "Carboniferous", "long": "the Carboniferous period"}, {"Ma": 419.2, "name": "Devonian", "long": "the Devonian period"}, {"Ma": 443.8, "name": "Silurian", "long": "the Silurian period"}, {"Ma": 485.4, "name": "Ordovician", "long": "the Ordovician period"}, {"Ma": 541.0, "name": "Cambrian", "long": "the Cambrian period"}, {"Ma": 635, "name": "Ediacaran", "long": "the Ediacaran period"}, {"Ma": 720, "name": "Cryogenian", "long": "the Cryogenian period"}, {"Ma": 1000, "name": "Tonian", "long": "the Tonian period"}, {"Ma": 1200, "name": "Stenian", "long": "the Stenian period"}, {"Ma": 1400, "name": "Ectasian", "long": "the Ectasian period"}, {"Ma": 1600, "name": "Calymmian", "long": "the Calymmian period"}, {"Ma": 1800, "name": "Statherian", "long": "the Statherian period"}, {"Ma": 2050, "name": "Orosirian", "long": "the Orosirian period"}, {"Ma": 2300, "name": "Rhyacian", "long": "the Rhyacian period"}, {"Ma": 2500, "name": "Siderian", "long": "the Siderian period"}]}, "IUCN": {"": "Not Evaluated", "NE": "Not Evaluated", "EN": "Endangered", "EX": "Extinct", "CR": "Critically Endangered", "EW": "Extinct in the Wild", "NT": "Near Threatened", "DD": "Data Deficient", "LC": "Least Concern", "VU": "Vulnerable"}, "Sponsored": "Sponsored", "sciname": "Scientific name: ", "Mya": "{mya} million years ago", "NameHits": "Search results", "Loading...": "Loading...", "leaf_sponsored_extra": ", text awaiting confirmation", "Sponsor": "Sponsor"}
</script>
  <script type="text/javascript">
    //include a few default funcs & params early on, so they can be used / overridden in the file which includes this layout
    var globals = {} /* A place to store global variables that are set in the file which includes this one */
    var extra_title = ""

    globals.UI_callbacks = {};

    globals.UI_callbacks.badOTT = function(ott) { 
      /* used within setup_page.js when the page tries to load a bad location */
      $("#error-modal a.OpenTreeSearchOnTree").attr("href","https://tree.opentreeoflife.org/opentree/argus/ottol@" +  ott.toString());
      $("#error-modal a.OpenTreeSearchInTaxonomy").attr("href","https://tree.opentreeoflife.org/taxonomy/browse?id=" + ott.toString());
      onezoom.controller.button_reset();
      UIkit.modal('#error-modal').show();
    };
    
    globals.UI_callbacks.closeAll = function() {
      
      $('.uk-modal-container').each(function() {
          UIkit.modal(this).hide(false); // Hide immediately, by default we wait in case mouse comes back
      });
      $('[uk-dropdown]').each(function() {
          UIkit.dropdown(this).hide(false); // Hide immediately, by default we wait in case mouse comes back
      });
    };
    
    /** Display / hide the loading spinner */
    globals.UI_callbacks.loadingMessage = function (active) {
      document.body.classList.toggle('loading', active);
    };
    
    globals.UI_callbacks.openCopyright = function(pic_src, pic_fn) {
      var load_url = "http://beta.onezoom.org/tree/pic_info.html/...PICSRC.../...PICFN...?embed=1".replace('...PICSRC...', pic_src || "").replace('...PICFN...', pic_fn || "");
      var link_url = "http://beta.onezoom.org/tree/pic_info/...PICSRC.../...PICFN...?redirect=1".replace('...PICSRC...', pic_src || "").replace('...PICFN...', pic_fn || "");
      $("#imageinfo-modal .popup-content .iframe-loading-info").show();
      $("#imageinfo-modal .popup-content .no-loading-info").hide();
      //Always load into a new iframe
      var ifrm = document.createElement("iframe");
      ifrm.setAttribute('src', load_url);
      ifrm.addEventListener('load', function() {
        
        $(".iframe-loading-info", $(this).parent().parent()).hide()
      }, false);
      ifrm.setAttribute("sandbox", "allow-same-origin allow-scripts allow-forms allow-popups");
      $("#imageinfo-modal .popup-content").append(ifrm);
      $("#imageinfo-modal .uk-modal-header a").attr('href', link_url);
      UIkit.modal('#imageinfo-modal').show();
      return [load_url, link_url]
    };
    
    /* called as soon as a request to open a linkouts window is made */
    globals.UI_callbacks.openLinkouts = function() {
      
      $('#external-modal .no-tab-data').hide();
      $('#external-modal .external-content').hide();
      $('#external-modal .tab-loading-info').show();
      UIkit.modal('#external-modal').show();
      
    };
    
    /* called when the API returns with details about contents of the linkouts window */
    globals.UI_callbacks.populateLinkouts = function(responseJSON, initialSelected) {
        console.log("populating linkout tabs with API data from", responseJSON);
      
      if (initialSelected) {
          initialSelected = $('#external-modal .external-tabs li').index($("#"+ initialSelected))
      } else {
          initialSelected = 0
      }
      var select_tab_index=null;
      var url_dict = responseJSON.data;
      var n_tabs = 0;
      // make sure the id names correspond to the names returned by the api
      $("#external-modal .external-tabs li").each(function(index) {
        var tab = $(this);
        var linkout_name = tab.attr('id'); //'wiki', 'eol', etc. Visited in order specified in html file
        if (linkout_name) {
          if (url_dict.hasOwnProperty(linkout_name) && url_dict[linkout_name].length) {
            var url_arr = url_dict[linkout_name] //contains the list of urls for this tab
            n_tabs += 1;
            tab.show(); //show the tab at the top (but not necessarily the content yet)
            if (select_tab_index == null) select_tab_index = index; //start selecting earliest non-hidden tab
            if (index == initialSelected) select_tab_index = index; //override if initialSelected is not hidden
            var specific_popup = $("#external-modal .popup-container ." + linkout_name);
            //set the data-src attribute to the url. When the tab is shown, it will get src from there
            specific_popup.attr("data-src", url_arr[0]);
            
            //define the linkout (some hackery here to allow the same element to act as a plain link or a 'post' submission)
            $(".expand-tab form input[type=hidden]", specific_popup).remove()
            switch (url_arr.length) {
                case 1: //only a single URL for the iframe and the linkout - use that for both
                  $(".expand-tab form", specific_popup).removeAttr("action");
                  $(".expand-tab form a", specific_popup).attr("href", url_arr[0]).removeAttr("onclick");
                  break;
                case 2: //second value in the response gives a different URL for the linkout
                  $(".expand-tab form", specific_popup).removeAttr("action");
                  $(".expand-tab form a", specific_popup).attr("href", url_arr[1]).removeAttr("onclick");
                  break;
                case 3: //third value in the response gives a set of key:value params to add as POST variables
                  $(".expand-tab form", specific_popup).attr("action", url_arr[1]);
                  $.each(url_arr[2], function(key, data) {
                      $(".expand-tab form", specific_popup).append($('<input>').attr({'type':'hidden','name':key,'value':data}));
                  });
                  $(".expand-tab form a", specific_popup).attr("onclick", "$(this).parent().submit();return false").removeAttr("href");
              }
          } else {
            
            tab.hide(); //hide irrelevant tabs (those not returned by the API)
          }
        }
      });
      if (n_tabs == 0) {
        
        $('#external-modal .no-tab-data').show()
      }
      UIkit.tab('#external-modal .external-tabs').show(select_tab_index);
      load_tab($("#external-modal .popup-container li").eq(select_tab_index));
      $('#external-modal .tab-loading-info').hide();
      $('#external-modal .external-content').show();
    };

  </script>

<!-- since this should be possible to run without a server, remove the ability to switch languages/pages -->
<style>
ul#controlButtons #tourButton {display: block;}
.treeswitch {display: none}
.langswitch {display: none}
</style>
<!-- could define js variables (specifically: pagetitle_func, tree_config, screensaver_config, tutorial_config) within <script> tags here -->
<script type="text/javascript">
var pagetitle_func = function(nm) {return (nm)?("OneZoom restricted: "+ nm):"OneZoom Tree of Life Explorer: restricted version"};
</script>
<script type="text/javascript">
var tour_config = {
        /* Settings general to the tour, rather that specific to each tour stop */
        "general": {
            confirm_template: "tour/exit_confirm.html", // Must be defined if the interaction parameter  
            confirm_template_style: "tour/exit_confirm.html", // ditto
            "dom_names": {
                /* The following values are actually the defaults, but we specify them
                 * here anyway for illustration purposes
                 */
                "wrapper_id": "tour_wrapper", /* the DOM id of the wrapper in which to
                * place the tour stops */
                "forward_class": "tour_forward",
                "backward_class": "tour_backward",
                "play_class": "tour_play",
                "pause_class": "tour_pause",
                "resume_class": "tour_resume",
                "exit_class": "tour_exit",
                "exit_confirm_class": "exit_confirm",
                "exit_cancel_class": "exit_cancel"
            }
        },
        "tourstop_shared": { /* These set the "default" values for any tourstop on this
             * tour. They are overridden by any identically named values defined in each
             * element of the "tourstop" array.
             */
            "template": "tour/tour_template.html",
            "template_style": "tour/tour_template.css",
            "hide_tourstop_style": {"display": "none"}, // This is the default. Alternatively
            "show_tourstop_style": {"display": "block"}, // try {"opacity":"0"} & {"opacity":"1"} or {"add_class": "active"}, {"remove_class": "active"}
            "update_class": {
                "title": "OneZoom Demo Tour",
            },
            "wait": 3000 /* For this tour, by default wait 3 seconds between each stop.
            * (if not specified, the default is null, meaning wait until the "next"
            * button is pressed.
            */
        },
        "tourstops": [
            {
                "ott": "991547",
                "update_class": {
                    "window_text": "Slide 1",
                    "img": {
                        "src": "http://images.onezoom.org/99/098/31338098.jpg"
                    },
                    "yt-container": {
                      "src": "http://www.youtube.com/embed/ngt0XLFgN28?rel=0"
                    },
                    "tour_backward": {
                        "style": {"visibility": "hidden"} /* Hide the backward button on
                        * the first stop. Any class can be hidden like this, even the
                        * whole window (class = .container)
                        */
                    },
                },
                "wait": 6000, /* Wait a bit longer here: 6 seconds */
                "wait_after_backward": 0  /* used if this stop is entered by going back */
            },
            {
                "ott": 991547,
                "transition_in": "leap", /* can be "fly" (default), "leap", or 
                * "fly_straight" (rare)
                */
                "update_class": {
                    "window_text": {
                        "html": "Slide 2 with style change",
                        "style": {"window_text": "gray_background"}},
                    "img": {
                        "src": "http://images.onezoom.org/99/727/26848727.jpg"
                    },
                      "yt-container": {
                      "src": "http://www.youtube.com/embed/yS1ibDImAYU?rel=0"
                      }
                },
                // set 'wait" to null to require pressing "next" to continue
                "wait": null
            },
            {
                "ott": "81461",
                "fly_in_speed": 2, /* speed relative to the global_anim_speed, as
                * accessed via controller.set_anim_speed() & controller.get_anim_speed()
                */
                "transition_in_visibility": "show_self", /* Should we show the tourstop on
                arrival (default), during transition-in ("show_self"), or force no
                tourstops to be shown during transition in ("force_hide"). If the default
                then the previous stop is likely to carry on being shown during
                transition, unless it has chosen to hide itself
                */ 
                "transition_in_wait": 1000, /* how long to wait (e.g. after showing self)
                before entering into the transition, in milliseconds.
                */
                "update_class": {
                    "container": {"style": {"visibility": "hidden"}} /* hide everything
                    */
                },
                "wait": 3000
            },
            {
                "ott": 81461,
                "pos": "max", /*  "pos" alters the final position. For a transition_in of
                * "fly" or "fly_straight" to an internal node (not leaf) of the tree, it
                * can be set to the string "max" which makes the transition end up with
                * the internal node filling the screen (i.e. children are not visible).
                * For a transition of "leap", it can be set to an object 
                * {'xp': xp, 'yp': yp, 'ws': ws} where xp, yp, ws are numbers giving the 
                * position relative to the node
                */
                "update_class": {
                    "window_text": "Slide 4",
                    "img": {
                        "style": {"visibility": "hidden"}
                    }
                },
                "wait": 1000
            },
            {
                "ott": null, /* "ott":null means return to the (rough) starting position
                */
                "update_class": {
                    "window_text": "The End",
                    "tour_forward": {
                        "style": {"visibility": "hidden"}
                    },
                "exec": null /* Only for javascript objects: define properties "on_start",
                * "on_show", or "on_exit" as functions. Those functions are executed
                * as the first event when arriving at a stop or when starting the
                * transition into a stop. The function is passed the tourstop object as
                * the first parameter so that you can access the text, the tour and its
                * controller. The function must return an array of any timers that it
                * initiates, so that they can be cancelled if necessary. 
                */
                },
            },
        ]
        };

// Until we finalise the UI for tours, define tours as happening when we click the
// "#tourButton", and inject tthe tour object into the onezoom object dynamically.

$(document).on("setupOneZoom", function(event, onezoom_object) {
    onezoom_object.tour = onezoom_object.utils.new_tour(onezoom_object);
    onezoom_object.add_hook('on_tree_loaded', () => {
        onezoom_object.tour.setup_setting(
            tour_config, 'main_tour',
            globals.UI_callbacks.closeAll, // before the tutorial runs, close modals etc.
            null, // nothing on tutorial end
            null, // nothing on premature exit
            null, // allow interaction to pause the tutorial
            function() {$(".tour_resume").show()} // if interaction, show the resume button
            )});
});

$(document).on("setupUI", function() {
    $('#controlButtons #tourButton .icon-container')
        .click(function () {
            onezoom.tour.start()  //activate tutorial
        })

});


</script>
<script>
    var title_name = "Minimal OneZoom page";
    if (window['pagetitle_func']) {
        document.title = pagetitle_func(title_name);
    } else {
        if (title_name) {
            document.title = "OneZoom" + extra_title + ": " + title_name;
        } else {
            document.title = "OneZoom" + extra_title + " Tree of Life Explorer";
        }
    }
</script>
  <noscript>
    <style>
        /* hide control buttons if there is no JS */
        #UI {display:none;}
    </style>
  </noscript>
</head>
<body id = "wholebody" style="user-select:none; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select:none; -ms-user-select:none;" unselectable = "on" class="loading tree-viewer">
    <!-- main body of document - canvas, then rest of UI elements in a single div -->
  <canvas id="OneZoomCanvasID" tabindex="1">
</canvas>
  <div id="tour_wrapper"></div>
  <div id="UI">
<!-- This contains all the overlay on top of the OneZoom canvas. It can be reloaded in different languages -->

<div class="logo uk-navbar-item"><a href="/" id="OZ-logo"><img src="images/oz-logo-1line-mono-dark.svg" /></a></div>

<div class="uk-navbar-item" id="searchnav">
  <div id="search-basic">
    <div class="searchbox uk-search uk-search-default" id="search_form_basic">
      <div class="searchinput"><div class="icon-beside-input">
          <button   class="spinner" uk-spinner="ratio:0.5"></button>
          <button   class="uk-icon main-icon">
            <img src="images/oz-logo-icon-darkbg.svg" alt="" />
          </button>
        </div><input class="uk-search-input" type="search" placeholder="Search all life..." /></div>
      <div uk-dropdown="pos: bottom-left; offset: 1" class="search_dropdown selectable uk-overflow-auto">
        <div class="no_results">No results found</div>
        <dl class="search_hits"></dl>
        <dl class="popular_species"></dl>
      </div>
    </div>
  </div>
  <div id="search-advanced">
    <ul id="searchboxes"><script>
//define the advanced searchbox html as a js variable so we can make an indefinate number of them
advSchbx='<li class="searchbox uk-search uk-search-default"><div><div class="searchresult">\
              <div class="icon-beside-input">\
                <button   class="main-icon" uk-icon="icon: location"></button>\
              </div><input class="uk-search-input" type="search" value="" readonly />\
            </div><div class="searchinput"><div class="icon-beside-input">\
                <button   class="spinner" uk-spinner="ratio:0.5"></button>\
                <button   class="main-icon" uk-icon="icon: search"></button>\
              </div><input class="uk-search-input" type="search" placeholder="Trace a path to..." />\
            </div><div uk-dropdown="pos: bottom-left;  offset: 1; mode: click" class="search_dropdown" class="selectable uk-overflow-auto">\
              <div class="no_results">No results found</div>\
              <dl class="search_hits"></dl>\
              <dl class="popular_species"></dl>\
            </div><button   class="remove-searchbox" title="Remove location box" uk-tooltip="pos: bottom-left" uk-icon="icon: minus-circle; ratio:0.8"></button></div></li>';
      </script></ul>
    <button   id="common_ancestor_button" uk-tooltip="pos: bottom-left" title="Go to common ancestor"><span uk-icon="icon: git-fork"></span>common ancestor</button>
    <button   id="add_searchbox" title="Add another location" uk-tooltip="pos: bottom-left" uk-icon="icon: plus-circle;"></button>
  </div>
</div>
<div id="advanced_search_toggle" class="uk-navbar-item">
    <a id="advanced_search_button" data-advanced-title="Turn off advanced search mode" data-simple-title="Advanced search (tracer) mode: click to turn on" class="uk-icon-button" uk-tooltip="pos: left" uk-icon="icon: git-fork"></a>
</div>

<div id="loading_spinner">
  <div uk-spinner="ratio: 3"></div>
</div>

<ul id="controlButtons" class="uk-iconnav uk-iconnav-vertical">
  <li id="locationButton">
    <div class='icon-container'>
      <a uk-icon="icon: compass"></a>
    </div>
    <div uk-dropdown="pos: right-bottom; delay-hide: 1000; boundary: #controlButtons; boundary-align: true" id="locationDropdown">
        <ol class="location-list"></ol>
    </div>
    <span class='button-label top-border top-right-radius top-padding'>Location</span>
  </li>
  <li id="inButton"    class="uk-visible@s">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Zoom in" uk-icon="icon: plus"></a>
    </div>
    <span class='button-label top-border'>Zoom in</span>
  </li>
  <li id="outButton"    class="uk-visible@s">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Zoom out" uk-icon="icon: minus"></a>
    </div>
    <span class='button-label'>Zoom out</span>
  </li>
  <li id="resetButton" class="uk-visible@s">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Reset view" uk-icon="icon: refresh"></a>
    </div>
    <span class='button-label'>Reset view</span>
  </li>
  <li id="screenshotButton">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Take an svg screenshot" onclick="make_screenshot(this);" uk-icon="icon: camera"></a>
    </div>
    <span class='button-label'>Take an svg screenshot</span>
  </li>
  <li id="singleInfoButton">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Information" href="#info-modal" uk-toggle uk-icon="icon: info"></a>
    </div>
    <span class='button-label top-border'>Information</span>
  </li>
  <li id="howToUseButton">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="How to use" uk-icon="icon: question"></a>
    </div>
    <span class='button-label'>How to use</span>
  </li>
  <li id="tourButton">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Take a tour" uk-icon="icon: world"></a>
    </div>
    <span class='button-label'>How to use</span>
  </li>
  <li id="hideControlsButton">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Hide panel" uk-icon="icon: triangle-left"></a>
    </div>
    <span class='button-label top-border bottom-border bottom-right-radius bottom-padding'>Hide panel</span>
  </li>
  <li id="showControlsButton">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Show panel" uk-icon="icon: triangle-right"></a>
    </div>
  </li>
  <li id="multipleInfoButton">
    <div class='icon-container'>
      <a uk-tooltip="pos: right" title="Information" onclick="$('.uk-tooltip.uk-active').hide()" uk-icon="icon: info"></a>
    </div>
    <span class='button-label'>Information</span>
  </li>

  <div id="infoDropdown" uk-dropdown="pos: right; mode: click;">
    <ul class="uk-nav uk-navbar-dropdown-nav uk-margin-left">
      <li><a href="#howuse-modal" uk-toggle><span uk-icon="icon: expand"></span>How to use</a></li>
      <li><a href="#about-modal" uk-toggle><span uk-icon="icon: expand"></span>About OneZoom</a></li>
      <li><a href="#datasources-modal" uk-toggle><span uk-icon="icon: expand"></span>Data sources</a></li>
      <li><a href="#terms-modal" uk-toggle><span uk-icon="icon: expand"></span>Terms of use</a></li>
    </ul>
  </div>
  
  <li><a uk-tooltip="pos: right" title="Settings" onclick="$('.uk-tooltip.uk-active').hide()" uk-icon="icon: settings"></a></li>
  <form id="settingsDropdown" class="uk-navbar-dropdown" uk-dropdown="pos: right-bottom; mode: click;">
    <ul class="uk-nav uk-navbar-dropdown-nav uk-margin-left">
      <li class="uk-nav-header">Image sources</li>
      <li><label uk-tooltip="pos: right" title="Show best image from any source: the image may not have been verified by a taxonomist. For any image, click or zoom on the © symbol for details.">
        <input class="uk-radio" type="radio" name="imgsource" value="best_any"> Any</label></li>
      <li><label uk-tooltip="pos: right" title="Only show images that have been verified by a taxonomist. For any image, click or zoom on the © symbol for details">
        <input class="uk-radio" type="radio" name="imgsource" value="best_verified"> Verified</label></li>
      <li><label uk-tooltip="pos: right" title="Only show public domain images (those not requiring the photographer or copyright holder to be listed when reusing OneZoom imagery)">
        <input class="uk-radio" type="radio" name="imgsource" value="best_pd"> Public domain</label></li>
      <li class="uk-nav-header">Tree shape</li>
      <li><label>
        <input class="uk-radio" type="radio" name="treeshape" value="spiral"> Spiral</label></li>
      <li><label>
        <input class="uk-radio" type="radio" name="treeshape" value="natural"> Natural</label></li>
      <li><label>
        <input class="uk-radio" type="radio" name="treeshape" value="fern"> Fern</label></li>
      <li><label>
        <input class="uk-radio" type="radio" name="treeshape" value="balanced"> Balanced</label></li>
      <li><label>
        <input class="uk-radio" type="radio" name="treeshape" value="polytomy"> Polytomy</label></li>

      <!-- <li class="uk-nav-header">Colours indicate</li>
      <li><label uk-tooltip="pos: right" title="Colours like a botanical tree, leaf colour shows extinction risk">
        <input class="uk-radio" type="radio" name="colourtype" value="natural"> Natural</label></li>
      <li><label>
        <input class="uk-radio" type="radio" name="colourtype" value="AT"> Ancestor’s Tale</label></li>
      <li><label>
        <input class="uk-radio" type="radio" name="colourtype" value="popularity"> Popularity</label></li> -->
      <li class="uk-nav-header treeswitch">Tree</li>
      <li class="treeswitch"><select id="treepage" class="uk-select uk-form-small">
        <option value="life">Original OneZoom</option>
        <option value="AT">Ancestor’s Tale</option>
        <!--<option value="linnean">Linnean Society</option>
        option value="kew">Kew</option> -->
        </select></li>
      <li class="uk-nav-header langswitch">Language</li>
      <li class="langswitch"><select id="language" class="uk-select uk-form-small" uk-tooltip="pos: right" title="Select a language (your current browser default is ‘English’). Most languages have some vernacular names on OneZoom, but only a few languages have been fully translated.">
        <option value="">Browser default</option>
        <optgroup label="Translated">
          <option value="en">English</option>
          <option value="fr">Français</option>
          <option value="sv">Svenska</option>
        </optgroup>
        <optgroup label="Not yet translated">
          <option value="zh">中文</option>
        </optgroup>
        </select></li>
        <li class="uk-nav-header animswitch">SEARCH MODE</li>
        <li class="animswitch">
          <li>
            <label>
              <input class="uk-radio" type="radio" name="searchmode" value="flight"> Fly
            </label>
          </li>
          <li>
            <label>
              <input class="uk-radio" type="radio" name="searchmode" value="jump"> Jump
            </label>
          </li>
        </li>
        </li>
    </ul>
  </form>
  
</ul>
<div id="error-modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <button class="uk-modal-close-outside" type="button" uk-close></button>
        <h2 class="uk-modal-title">Error</h2>
        <div class="badOTT"><h2>Sorry, the species or group that you asked for is not on the OneZoom tree.</h2><p id="noOTTtext"></p><p>Meanwhile, we have taken you to the root of the OneZoom tree.</p>
<p>The Open Tree contains additional species not on the OneZoom tree (particularly subspecies and fossils). To check if this is why we cannot find your species or group, you can <a class="OpenTreeSearchOnTree">look for this taxon on the Open Tree of Life</a>, or <a class="OpenTreeSearchInTaxonomy">search the taxonomy database that they maintain</a>. However, if you can’t find it via either of these links, or by <a href="https://tree.opentreeoflife.org">searching the Open Tree</a>, then chances are you have entered a wrong number or a misspelt name.<p></div>
    </div>
</div>
<div id="info-modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-outside" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h2 class="uk-modal-title">More information</h2>
        </div>
        <div class="uk-modal-body" uk-overflow-auto><p class="uk-position-center unloaded">Getting OneZoom information<br /><img src="images/ajax-loader.gif" /></p></div>
    </div>
</div>
<div id="about-modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-outside" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h2 class="uk-modal-title">About the OneZoom tree of life</h2>
        </div>
        <div class="uk-modal-body" uk-overflow-auto><p class="uk-position-center unloaded">Getting OneZoom information<br /><img src="images/ajax-loader.gif" /></p></div>
    </div>
</div>
<div id="howuse-modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-outside" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h2 class="uk-modal-title">How to use the OneZoom explorer</h2>
        </div>
        <div class="uk-modal-body" uk-overflow-auto><p class="uk-position-center unloaded">Getting OneZoom information<br /><img src="images/ajax-loader.gif" /></p></div>
    </div>
</div>
<div id="datasources-modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-outside" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h2 class="uk-modal-title">Sources for the data used in this tree</h2>
        </div>
        <div class="uk-modal-body" uk-overflow-auto><p class="uk-position-center unloaded">Getting OneZoom information<br /><img src="images/ajax-loader.gif" /></p></div>
    </div>
</div>
<div id="terms-modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-outside" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h2 class="uk-modal-title">Terms and conditions</h2>
        </div>
        <div class="uk-modal-body" uk-overflow-auto><p class="uk-position-center unloaded">Getting OneZoom information<br /><img src="images/ajax-loader.gif" /></p></div>
    </div>
</div>
<div id="imageinfo-modal" class="uk-modal-container" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-outside" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h2 class="uk-modal-title">Image information<a target="_blank" class="uk-icon-button expand-tab" uk-tooltip="pos: left" title="Open this in a new window" uk-icon="icon: expand; ratio: 0.75" style=""></a></h2>
        </div>
        <div class="uk-modal-body popup-content iframe-container">
          <p class="no-loading-info uk-position-center">No image specified, sorry</p>
          <p class="iframe-loading-info uk-position-center" style="display:none">Waiting for image information to load<br /><img src="images/ajax-loader.gif" /></p>
        </div>
    </div>
</div>
<div id="external-modal" class="uk-modal-container" uk-modal>
  <div class="uk-modal-dialog">
    <button class="uk-modal-close-outside" type="button" uk-close></button>
    <div class="no-tab-data uk-position-center"><h3>No data available</h3><p>Sorry, we do not have any extra information for this species or group</p></div>
    <p class="tab-loading-info uk-position-center" style="display:none">Waiting for further information details from OneZoom<br /><img src="images/ajax-loader.gif" /></p>
    <div class="external-content" style="display:none">
      <ul uk-tab class="external-tabs">
        <!--A list of all the available tabs-->
        
        <li id="wiki"><a href="#"><img src="images/W.svg" title="Wikipedia" class="uk-hidden@s" /><span class="uk-visible@s">Wikipedia</span></a></li>
        
        <li id="eol"><a href="#"><img src="images/EoL.png" title="Encyclopedia of Life" class="uk-hidden@s" /><span class="uk-visible@s">Encyclopedia of Life</span></a></li>
        
        <li id="iucn"><a href="#"><img src="images/IUCN_Red_List.svg" title="Conservation" class="uk-hidden@s" /><span class="uk-visible@s">Conservation</span></a></li>
        
        <li id="ncbi"><a href="#"><img src="images/DNA_icon.svg" title="Genetics" class="uk-hidden@s" /><span class="uk-visible@s">Genetics</span></a></li>
        
        <li id="ozspons"><a href="#"><img src="images/sponsor.png" title="Sponsor" class="uk-hidden@s" /><span class="uk-visible@s">Sponsor</span></a></li>
        
      </ul>
      <ul class="popup-container uk-switcher">
        
        <li class="wiki" data-name="Wikipedia" data-src="" aria-controls="wiki-panel">
          <div class="uk-position-top-right expand-tab" style="">

            <form class="no_disable" target="_blank" method="post" onsubmit="return true"><a class="uk-icon-button" uk-tooltip="pos: left" title="Open this Wikipedia tab in a new window" uk-icon="icon: expand; ratio: 0.75" target="_blank"></a></form>

          </div>
          <p class="iframe-loading-info uk-position-center">Waiting for Wikipedia page to load<br /><img src="images/ajax-loader.gif" /></p>
        </li>
        
        <li class="eol" data-name="Encyclopedia of Life" data-src="" aria-controls="eol-panel">
          <div class="uk-position-top-right expand-tab" style="">

            <form class="no_disable" target="_blank" method="post" onsubmit="return true"><a class="uk-icon-button" uk-tooltip="pos: left" title="Open this Encyclopedia of Life tab in a new window" uk-icon="icon: expand; ratio: 0.75" target="_blank"></a></form>

          </div>
          <p class="iframe-loading-info uk-position-center">Waiting for Encyclopedia of Life page to load<br /><img src="images/ajax-loader.gif" /></p>
        </li>
        
        <li class="iucn" data-name="Conservation" data-src="" aria-controls="iucn-panel">
          <div class="uk-position-top-right expand-tab" style="">

            <form class="no_disable" target="_blank" method="post" onsubmit="return true"><a class="uk-icon-button" uk-tooltip="pos: left" title="Open this Conservation tab in a new window" uk-icon="icon: expand; ratio: 0.75" target="_blank"></a></form>

          </div>
          <p class="iframe-loading-info uk-position-center">Waiting for Conservation page to load<br /><img src="images/ajax-loader.gif" /></p>
        </li>
        
        <li class="ncbi" data-name="Genetics" data-src="" aria-controls="ncbi-panel">
          <div class="uk-position-top-right expand-tab" style="">

            <form class="no_disable" target="_blank" method="post" onsubmit="return true"><a class="uk-icon-button" uk-tooltip="pos: left" title="Open this Genetics tab in a new window" uk-icon="icon: expand; ratio: 0.75" target="_blank"></a></form>

          </div>
          <p class="iframe-loading-info uk-position-center">Waiting for Genetics page to load<br /><img src="images/ajax-loader.gif" /></p>
        </li>
        
        <li class="ozspons" data-name="Sponsor" data-src="" aria-controls="ozspons-panel">
          <div class="uk-position-top-right expand-tab" style="">

            <form class="no_disable" target="_blank" method="post" onsubmit="return true"><a class="uk-icon-button" uk-tooltip="pos: left" title="Open this Sponsor tab in a new window" uk-icon="icon: expand; ratio: 0.75" target="_blank"></a></form>

          </div>
          <p class="iframe-loading-info uk-position-center">Waiting for Sponsor page to load<br /><img src="images/ajax-loader.gif" /></p>
        </li>
        
      </ul>
    </div>
  </div>
</div>

</div>
  <script type="text/javascript">
/* define most of the JS after the main page has loaded */
var onezoom = null; //will be filled out on document ready
var locations_json = '["Popular places",{"OTT":244265},{"OTT":770315},{"OTT":81461},{"OTT":991547},{"OTT":801601},{"OTT":1062253},{"OTT":691846},{"OTT":361838},{"OTT":99252},{"OTT":1012685, "en":"Mushrooms"},{"OTT":304358}]';

/* UI functions that allow javascript in the main viewer to interact with the UI.
    Names for each function are hard-coded into the OneZoom viewer  in config.ui within 
    global_config.js. These refer to items in the viewer_UI file */


function closeAndLeap(event, OZIDin, original_searchbox) {
    //TODO: add hit in search count.
    // add_hit_in_search_count(OZIDin);
    var dropdown = $(".search_dropdown", original_searchbox)
    if (dropdown.length) {
        if ((dropdown.first().outerWidth()*2) > document.getElementById("OneZoomCanvasID").width) {
            globals.UI_callbacks.closeAll();
        }
    }
    if (OZIDin) onezoom.controller.default_move_to(OZIDin);
}


function load_tab(tab_content) {
  if (! tab_content.children().last().hasClass('popup-content')) {
      $('.iframe-loading-info',tab_content).show();
      
      var ifrm = document.createElement("iframe");
      ifrm.setAttribute('src', tab_content.attr('data-src'));
      ifrm.addEventListener('load', function() {
        
        $(".iframe-loading-info", $(this).parent().parent()).hide()
        }, false);
      ifrm.setAttribute("sandbox", "allow-same-origin allow-scripts allow-forms allow-popups");
      //add iframe inside a div wrapper
      tab_content.append($('<div>', {'class':'popup-content iframe-container'}).append(ifrm));
  }
}

/* Add a set of species (e.g. popular species) to a target list, 
 * by using the onezoom.utils.process_taxon_list() function
 * to map OTT ids to OneZoom IDs / vernacular names.
 * The parameter 'click_callback_id_name' should be a
 * callback that is fired when an item is clicked on in the list
 * (called with event, OZid, item_name, sci_name, dropdown)
 */
function setup_location_list(target, taxon_list_json, click_callback_id_name) {
    target.empty();
    onezoom.utils.process_taxon_list(
        taxon_list_json, 
        function(ott, given_name, sciname, OZid) {
            if (OZid) {
                target.append(
                    $('<dd>').html(
                        $('<p>')
                            .html(given_name?$('<span></span>').text(given_name):$('<i></i>').text(sciname))
                            .addClass('taxon_location_button')
                            .attr("draggable","true")
                            .attr("id",'menuitem'+OZid.toString())
                            .attr("data-OZid",OZid.toString())
                            .attr("data-given_name", given_name)
                            .attr("data-sciname", sciname)
                            .click(function(event) {
                                click_callback_id_name(event, OZid.toString(), given_name, sciname);
                            })
                            .on('dragstart', function(event){
                                 event.originalEvent.dataTransfer.setData('drop_id', $(this).attr('id'));
                                 event.originalEvent.dataTransfer.setData('taxon', true);
                            })
                    )
                );
            }
        },
        function(header) {target.append($('<dt>').text(OZstrings.hasOwnProperty(header)?OZstrings[header]:header))});
}

var previous_location_codes;
/* Function to call when location menu is clicked
 * will be filled out with call to API using update_location_menu(onezoom.controller.get_my_location())
 */
function update_location_menu(loc_root) {
  var my_location = loc_root[0]
  var root = loc_root[1]
  var my_location_names = my_location[0];
  var my_location_codes = my_location[1];
  var my_location_richness = my_location[3];
  if (JSON.stringify(my_location_codes) === previous_location_codes) {
    //Do not change location dropdown lists if the location has not changed.
    return;
  } else {
    previous_location_codes = JSON.stringify(my_location_codes);
  }
  
  // first remove everything in the current list
  var loc_list = $(".location-list").empty()
  // now rebuild the list
  loc_list.append(
      $('<li>').addClass('toploc').append(
          $('<a>').append(OZstrings["Current location"])));
  // add the main elements, in reverse order
  for (var i = my_location_names.length-1; i >= 0; i--)
  {
    
    var richnessProportion = my_location_richness[i+1]/my_location_richness[i];
    richnessProportion = Math.min(richnessProportion, 1.0-6.0/$('#locationDropdown').width()); //never have richness prop = 1 (looks odd): always add 6 px on
    var richnessRemainder = Math.floor((1.0 - richnessProportion)/2.0 * $('#locationDropdown').width());
    var richnessWidth = $('#locationDropdown').width()-2*richnessRemainder;
    loc_list.append(
      $('<li>')
        .width(richnessWidth)
        .css({'border-right-width': richnessRemainder+'px','border-left-width': richnessRemainder+'px'})
        .append(
          $('<a>')
            .css('margin-left', '-' + richnessRemainder + 'px')
            .data('locationCode', my_location_codes[i])
            .click(function() { /* close And Fly */
              if (((document.getElementById("locationDropdown").offsetWidth)*2) > onezoom.tree_state.widthres) {
                
                $("#locationDropdown").hide();
              };
              onezoom.controller.fly_on_tree_to($(this).data('locationCode'));
            })
            .append(my_location_names[i] + "<br>(" + onezoom.utils.number_convert(my_location_richness[i]) + ")")
        )
    );
  }
}

function load_into_searchbox(searchbox, OZIDin, given_name, sciname, colour) {
    //Place a non-editable box of the selected item [given_name (/sci_name/)]
    //over the top of the original search box and replace the search icon
    //with an appropriately coloured pin icon. Clicking the pin should
    //do a closeAndLeap() to the appropriate place
    //will also jump to the common ancestor of all the marked places
    //capitalise the common name
    var searchresult = $('.searchresult', searchbox);    
    if (given_name) given_name = given_name.charAt(0).toUpperCase() + given_name.slice(1);
    if (given_name && sciname) {
        $('input',searchresult).attr('value', given_name + " (" + sciname + ")");    
    } else {
        $('input',searchresult).attr('value',(given_name || '') + (sciname || ''));
    }
    searchresult.attr('data-OZid', OZIDin);
    searchbox.addClass('result_displayed_in_box');
    //once the svg is loaded into the icon, change the colour of the icon
    UIkit.icon($('.icon-beside-input .main-icon',searchresult)).svg.then(function() {
        $('.icon-beside-input .main-icon svg path',searchresult).css('fill',colour);
        $('.icon-beside-input .main-icon svg circle',searchresult).css('fill','white');
    });
};

function UI_reset_marked(searchbox, OZIDin, given_name, sciname, event) {
    //create a new mark, and load into a searchbox 
    var searchresult = $('.searchresult', searchbox);
    
    UIkit.dropdown($('.search_dropdown', searchbox)).hide();
    if (searchresult.attr('data-OZid')) {
        onezoom.controller.unmark_area(searchresult.attr('data-OZid'));
    }
    var colour = onezoom.controller.mark_area(OZIDin);
    load_into_searchbox(searchbox, OZIDin, given_name, sciname, colour);    
    closeAndLeap(event, onezoom.controller.get_ancestor_of_marked(), searchbox);
}

function UI_reset_marked_via_event(event, OZIDin, given_name, sciname) {
    //fired when an item is selected in an advanced dropdown
    UI_reset_marked($(event.currentTarget).closest('.searchbox'), OZIDin, given_name, sciname, event);
}

function toggleAdvancedSearch(state) {
    //toggles advanced search mode, or switches it on (state=true) or off (state=false)
    if (state == null) {
        //toggle the current state
        state = !$('#searchnav').hasClass("advanced_mode");
    }
    if (state) {
        $('#searchnav').addClass("advanced_mode");
        UIkit.getComponent(UIkit.util.$('#advanced_search_button'), 'tooltip').title = $('#advanced_search_button').attr("data-advanced-title")
        $('#advanced_search_button')
            .attr('uk-icon','icon: close');
    } else {
        $('#searchnav').removeClass("advanced_mode");
        UIkit.getComponent(UIkit.util.$('#advanced_search_button'), 'tooltip').title = $('#advanced_search_button').attr("data-simple-title")
        $('#advanced_search_button')
            .attr('uk-icon','icon: git-fork');
    }
}

function add_advanced_searchbox(OZid, name, sciname, col) {
    /* Add an advanced searchbox, and attach all the necessary listeners.
     * This is done dynamically so that we can add and remove them easily.
     * If any parameters are given, we set the box to those values
     */
    var box_selector = $(advSchbx).appendTo('#searchboxes');
    $('.search_dropdown', box_selector)
        .on('show', function(event) {
            //have to recalc the max height here as we need to dynamically work out the dropbox posn
            $(event.currentTarget).css("max-height", "calc(100vh - 5px - " + $(event.currentTarget).offset().top + "px)");
        });

    $('.remove-searchbox', box_selector)
        .click(function(event) {
            var searchbox = $(event.currentTarget).closest('.searchbox');
            var highlighted = $('.searchresult', searchbox).attr('data-OZid');
            if (highlighted) onezoom.controller.unmark_area(highlighted);
            searchbox.remove();
            if ($('#search-advanced #searchboxes li').length == 0) {
                toggleAdvancedSearch(false);
                //add 2 searchboxes back
                add_advanced_searchbox();
                add_advanced_searchbox();
            }
        });

    $('.searchresult .main-icon', box_selector).on('ready', function(event) {
    });

    
    $('.searchresult .icon-beside-input .main-icon', box_selector)
        .on('click',function(event) {
               
            var OZid = $(event.currentTarget).closest('.searchresult').attr('data-OZid');
            if (OZid) closeAndLeap(event, OZid, box_selector);
            event.preventDefault();
            event.stopPropagation();
        })
        
    $('.searchresult input', box_selector)
        .click(function(event) {
            var searchbox = $(event.currentTarget).closest('.searchbox');
            searchbox.removeClass('result_displayed_in_box');
            $('.searchinput input', searchbox).focus();
            UIkit.dropdown($('.search_dropdown', searchbox)).show();
            event.preventDefault()
            event.stopPropagation();
        });
    $('.searchinput .icon-beside-input .main-icon', box_selector)
        .mousedown(function(event) {
            // Fires before the blur event, catch this and stop overlaying the result, so that if 
            // we lose focus because we touched the magnifying glass, we stil get the dropdown
            var searchbox = $(event.currentTarget).closest('.searchbox');
            if ($('.searchinput input', searchbox).is(":focus")) {
                event.preventDefault()
                event.stopPropagation();
                return false;
            } else {
                return true;
            };
        })
        
    $('.searchinput input', box_selector)
        .blur(function(event) {
            // if we have an already-selected location, and we lose focus, we simply revert
            var searchbox = $(event.currentTarget).closest('.searchbox');
            if ($('.searchresult', searchbox).attr('data-OZid')) {
                searchbox.addClass('result_displayed_in_box');
            }
        })
        .on('keyup', function(event) {
            
            var search_term = this.value;
            var searchbox = $(this).closest('.searchbox');
            var searchresult = $('.searchresult', searchbox);
            var dropdown = $('.search_dropdown', searchbox);
            if (searchresult.attr('data-OZid')) {
                onezoom.controller.unmark_area(searchresult.attr('data-OZid'));
                searchresult.attr('data-OZid','');
            }
            if (search_term.length==0) {
                $('.popular_species', dropdown).show();
                
                $('.no_results', dropdown).hide();
                $('.search_hits', dropdown).empty();
                onezoom.search_manager.full_search(""); // this clears the search
                $('.searchinput', searchbox).removeClass('waiting_for_search_result');
            } else {
                //$('.searchinput', searchbox).addClass('waiting_for_search_result');
                var delay_ms = 1000;
                if (event.which == 13) {
                    delay_ms = 1;   //enter was pressed - don't delay
                }
            if ((search_term.replace(/ /g,'').length > 2)||((search_term.replace(/ /g,'').length > 1)&&(delay_ms == 1))) { // we're never going to search for a single character and we only search for two characters if enter has been pressed.
            
            //if (search_term.replace(/ /g,'').length > 1) { // we're never going to search for a single character
            
            onezoom.search_manager.full_search(
                search_term,
                function(original_string, actual_search, results) {
                    search_ui.searchPopulate(searchbox, original_string, results, UI_reset_marked_via_event)},
                delay_ms,
                function() {
                    
                    if(!($(".searchinput").hasClass('waiting_for_search_result'))) {
                        $(".searchinput", searchbox).addClass('waiting_for_search_result'); // switch flag for search to on
                    }});
            }
            }
        });
        
    setup_location_list($('.popular_species', box_selector), locations_json, UI_reset_marked_via_event);

    if (OZid) {
        if (!col) col = onezoom.controller.mark_area(OZid);
        //look up this OZid, and use OZid, name, sciname, colour to show the result
        //use a timeout to allow the icon time to load, so we can colour it
        load_into_searchbox(box_selector, OZid, name, sciname, col);
    }
}

function preventTouchZoom(event) {
    if(event.touches.length > 1) {
        event.preventDefault(); 
        event.stopPropagation();
    };
}

function setupUI() {
    /*
     Used whenever the UI component is loaded (e.g. at start or on language change)
    */

    /* Make sure we scroll the canvas, not the body behind it */
    $(document.body).on("touchstart touchmove touchend", preventTouchZoom);

    /* make sure we can't zoom on UI items */
    $("#UI").on("touchstart touchmove touchend", preventTouchZoom);
    $("[uk-modal]").on("touchstart touchmove touchend", preventTouchZoom);

    $('#outButton .icon-container')
        .click(function(){onezoom.controller.button_zoom_up()});
    $('#inButton .icon-container')
        .click(function(){onezoom.controller.button_zoom_in()});
    $('#resetButton .icon-container')
        .click(function(){onezoom.controller.button_reset()});

    /* Control Button Hint Toggle */
    $('#controlButtons #hideControlsButton .icon-container')
        .click(function() {
            $('#controlButtons').addClass('button-label-hidden')
        })

    $('#controlButtons #showControlsButton .icon-container')
        .click(function () {
            $('#controlButtons').removeClass('button-label-hidden')
        })
    
    $('#controlButtons #howToUseButton .icon-container')
        .click(function () {
            onezoom.tutorial.start()  //activate tutorial
        })

    $('input[name="imgsource"]').change(function() {onezoom.controller.set_image_source(this.value)});
    $('input[name="treeshape"]').change(function() {onezoom.controller.change_view_type(this.value)});
    $('input[name="colourtype"]').change(function() {onezoom.controller.change_color_theme(this.value)});
    $('input[name="searchmode"]').change(function () { onezoom.controller.set_search_jump_mode(this.value) });
    $('select#language').change(function() {
        //reset the OZ strings to the new language
        var lang_param = (this.value)?('lang='+this.value):'';
        var self = this;
        $.getJSON('/treeviewer/js_strings.json?' + lang_param, {}, function(json){
            OZstrings = json;
            onezoom.controller.set_language(self.value);
            //reset the UI to a new language
            $('[uk-modal]').remove(); //UIkit modals jump around the DOM, so need deleting by hand
            $('#UI').load('/treeviewer/UI_layer.load?tabs=default&'+lang_param, setupUI)
        });
    })
    $('select#treepage').val('minlife_tour');
    $('select#treepage').change(function() {
        /* slighly yucky function here - to go to the same location on another tree (another page), we 
           replace the current url parameter (e.g. life.html, linnean.html, etc) with the
           new value, by search-and-replace in the location.pathname component. We then paste
           the url back together again as "origin + new_pathname + search + hash" */
        window.location.href= window.location.origin + 
            window.location.pathname.replace("/minlife_tour","/" + this.value) +
            window.location.search +
            window.location.hash;
    });

    $('#settingsDropdown')
      .on('show', function() {
       $('input[name=imgsource]').val([onezoom.controller.get_image_source()]);
       $('input[name=treeshape]').val([onezoom.controller.get_view_type()]);
       $('input[name=colourtype]').val([onezoom.controller.get_color_theme()]);
       $('select#language').val(onezoom.controller.get_language());
       $('input[name=searchmode]').val([onezoom.controller.get_search_jump_mode()]);
    });

    $('#locationDropdown')
      .on('beforeshow', function() {
        update_location_menu(onezoom.controller.get_my_location());
        return true;
      })
      /* this hack doesn't seem to work
      .on('show', function () {
        $('#locationDropdown').css("min-height","0");
      })
      .on('hide', function () {
        $('#locationDropdown').css("min-height","100%");
      })*/

    
    $('#advanced_search_button')
      .on("dragover", function(event) {
        $(this).addClass('dragover');
        event.preventDefault();
        event.stopPropagation();
      })
      .on("dragleave", function(event) {
        event.preventDefault();
        event.stopPropagation();
        $(this).removeClass('dragover');
      })
      .on("drop", function(event) {
        event.preventDefault();  
        event.stopPropagation();
        if (event.originalEvent.dataTransfer.getData('taxon')) {
            var dropped_item = $('#' + event.originalEvent.dataTransfer.getData('drop_id'))
            //find the first unused advanced search box
            var to_fill = $('#search-advanced .searchresult:not([data-OZid])').first().closest('.searchbox');
            if (to_fill.length) {
                UI_reset_marked(
                    to_fill,
                    dropped_item.attr("data-OZid"),
                    dropped_item.attr("data-given_name"), 
                    dropped_item.attr("data-sciname")
                );
            } else {
                add_advanced_searchbox(
                    dropped_item.attr("data-OZid"),
                    dropped_item.attr("data-given_name"), 
                    dropped_item.attr("data-sciname")
                );
            }
            toggleAdvancedSearch(true);
            $(this).removeClass('dragover');
        }
      })
      .click(function() {
        //switch on or off common ancestor mode
        toggleAdvancedSearch()
      });
    
    $('#search_form_basic')
      .submit(function(event) {
        //stop form submission reloading the page
        event.preventDefault();
      })
    
    $('#search-basic .searchinput input')
      .keyup(function(event) {
        var search_term = this.value;
        var searchbox = $(this).closest('.searchbox');
        var dropdown = $('.search_dropdown', searchbox);
        if (search_term.length==0) {
            $('.popular_species', dropdown).show();
            
            $('.no_results', dropdown).hide();
            $('.search_hits', dropdown).empty();
            onezoom.search_manager.full_search("");
            $('.searchinput', searchbox).removeClass('waiting_for_search_result');
        } else {
            var delay_ms = 1000;
            if (event.which == 13) {
                delay_ms = 1;   //enter was pressed - don't delay
                // we should probably catch the case of short string here and give the user a warning - todo.
            }
            if ((search_term.replace(/ /g,'').length > 2)||((search_term.replace(/ /g,'').length > 1)&&(delay_ms == 1))) { // we're never going to search for a single character and we only search for two characters if enter has been pressed.
             
             // we want to test for whether the search is working already or not....
             
             onezoom.search_manager.full_search(
                                                search_term,
                                                function(original_string, actual_search, results) {
                                                search_ui.searchPopulate(searchbox, original_string, results, function(event, OZid) {
                                                    event.preventDefault();  // Don't follow links
                                                    closeAndLeap(event, OZid, $('#search-basic'));
                                                })
                                                },
                                                delay_ms,
                                                function() {
                                                    

                                                        if(!($(".searchinput").hasClass('waiting_for_search_result')))
                                                        {
                                                            $(".searchinput", searchbox).addClass('waiting_for_search_result'); // switch flag for search to on
                                                        }
                                                    }
                                                );
             
             }
             else
             {
                // the user should get some comment back here ideally because they tried to search for a single character
             }
        }
      });
    
    $('#search-basic .search_dropdown')
        .on('show', function(event) {
            //have to recalc the max height here as we need to dynamically work out the dropbox posn
            $(event.currentTarget).css("max-height", "calc(100vh - 5px - " + $(event.currentTarget).offset().top + "px)");
        })
    
    /* Advanced search stuff */
    $('#add_searchbox')
        .click(function(event) {
            add_advanced_searchbox();
            event.preventDefault();
        });
    $('#common_ancestor_button')
        .click(function(event) {
            var OZid = onezoom.controller.get_ancestor_of_marked();
            if (OZid !== null) {
                closeAndLeap(event, OZid);
            }
            event.preventDefault();
        });
        
    /*** MODALS ***/
    $('#info-modal')
        .on('beforeshow', function() {
            /* to avoid loading all the text on page load, we check here and load it via ajax if necessary */
            if ($("#info-modal .uk-modal-body > .unloaded").length) {
                var url = 'http://beta.onezoom.org/treeviewer/about_plus_data.load?tabs=default';
                
                $("#info-modal .uk-modal-body").load(url);
            }
        });

    $('#about-modal')
        .on('beforeshow', function() {
            /* to avoid loading all the text on page load, we check here and load it via ajax if necessary */
            if ($("#about-modal .uk-modal-body > .unloaded").length) {
                var url = 'http://beta.onezoom.org/about.load?tabs=default';
                
                $("#about-modal .uk-modal-body").load(url);
            }
        });

    $('#howuse-modal')
        .on('beforeshow', function() {
            /* to avoid loading all the text on page load, we check here and load it via ajax if necessary */
            if ($("#howuse-modal .uk-modal-body > .unloaded").length) {
                var url = 'http://beta.onezoom.org/how.load?tabs=default';
                
                $("#howuse-modal .uk-modal-body").load(url);
            }
        });

    $('#datasources-modal')
        .on('beforeshow', function() {
            /* to avoid loading all the about text on page load, we check here and load it via ajax if necessary */
            if ($("#datasources-modal .uk-modal-body > .unloaded").length) {
                var url = 'http://beta.onezoom.org/data_sources.load?tabs=default';
                
                $("#datasources-modal .uk-modal-body").load(url);
            };
        });

    $('#terms-modal')
        .on('beforeshow', function() {
            /* to avoid loading all the text on page load, we check here and load it via ajax if necessary */
            if ($("#terms-modal .uk-modal-body > .unloaded").length) {
                var url = 'http://beta.onezoom.org/terms.load/site?tabs=default';
                
                $("#terms-modal .uk-modal-body").load(url);
            };
        });

    $('#imageinfo-modal')
        .on('hide', function() {
             $("#imageinfo-modal .uk-modal-header a").removeAttr('href');
             $('#imageinfo-modal .popup-content iframe').remove();
             $('#imageinfo-modal .popup-content .no-loading-info').show();
        });
    
    /*** Model for external tabs, e.g. wikipedia (must create & destroy tabbed content (e.g. iframes)) ***/
    $('#external-modal')
      .on('hidden', function() {
        
        $('#external-modal .popup-container li').each(function() {
            $(this)
                .attr("data-src","")
                .children('.popup-content').remove()
                .children('form').removeAttr("action")
                .children('form a').removeAttr("href onclick")
                .children('form input').remove()
                .children('.iframe-loading-info').show()
        });
        $('#external-modal .no-tab-data').show();
        $('#external-modal .external-content').hide();
        $('#external-modal .tab-loading-info').hide();
      });

    $('#external-modal .popup-container li').on('show', function (event) {
        if ($(event.currentTarget).attr("data-src")) {
            load_tab($(event.currentTarget));
        }
        event.stopPropagation();
    });
    
    $('#external-modal .popup-container li').on('hidden', function (event) {
        /* make sure hiding anything within the container does not bubble up
         * and make us think the entire modal has been hidden.
         
         We probably don't need this now...
         */
        event.stopPropagation();
    });

    setup_location_list($('#search-basic .popular_species'), locations_json, 
        function(event, OZid) {closeAndLeap(event, OZid, $('#search-basic'))});

    var existing_searchresults = onezoom.controller.list_all_marked().filter(function(id_col) {return !isNaN(id_col[0])});
    if (existing_searchresults.length) {
        var colours = {};
        var ids = [];
        for(var i=0; i<existing_searchresults.length; i++) {
           ids.push(existing_searchresults[i][0]);
           colours[existing_searchresults[i][0]]=existing_searchresults[i][1]
        }
        //must look up the names & values via the API
        onezoom.search_manager.lookup_nodes(ids, function(OZIDin, ott, sciname, vernacular, image_src_ids, image_srcs, date) {
           add_advanced_searchbox(OZIDin, vernacular, sciname, colours[OZIDin]);
        },'best_pd');
        toggleAdvancedSearch(true);
    } else {
        //add 2 searchboxes as default
        add_advanced_searchbox();
        add_advanced_searchbox();
        toggleAdvancedSearch(false);        
    }

    $(document).triggerHandler("setupUI", onezoom);
}

$(document).ready(function() {    /* Mainly a place to attach JS event handlers */
    // Set up some global variables
    /** CREATE A ONEZOOM INSTANCE
    this allows us to access e.g. onezoom.controller, onezoom.config, etc (defined in OZentry.js)
     **/
    
    
    setup_onezoom()

    function setup_onezoom() {  
        onezoom = OZentry.default(
            window.server_urls,
            window.globals.UI_callbacks,
            window.pagetitle_func,
            'OneZoomCanvasID',
            window['tree_config'],
            window.rawData,
            window.metadata,
            window.cut_position_map_json_str,
            window.polytomy_cut_position_map_json_str,
            window.cut_threshold,
            window.tree_date);

        onezoom.add_hook('on_tree_loaded', () => {
            onezoom.tutorial.setup_setting(
                globals['tutorial_config'], 'tutorial',
                globals.UI_callbacks.closeAll, // before the tutorial runs, close modals etc.
                null, // nothing on tutorial end
                null, // nothing on premature exit
                null, // allow interaction to pause the tutorial
                function() {$(".tour_resume").show()} // if interaction, show the resume button
                )})
        /* The screensaver is a type of tour with a different calling signature */
        onezoom.add_hook('on_tree_loaded', () => {
            onezoom.screensaver.setup_setting(
                // screensaver_config may only be defined for some displays
                window.globals['screensaver_config'], 'screensaver',
                globals.UI_callbacks.closeAll, // before the screensaver runs, close modals etc.
                true, // loop back and forth
                null, // nothing on screensaver exit
                );
        })
        $(document).triggerHandler("setupOneZoom", [onezoom])
    
        setupUI();
    }
})

  </script>
</body>
</html>
